{% extends 'base.html' %}
{% load static %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Inventario Locales ChileanTrading</h5>

    <div>
        <a href="{% url 'importar_excel' %}" class="btn btn-primary btn-sm">
             Importar Excel
        </a>
        <a href="{% url 'exportar_excel' %}" class="btn btn-success btn-sm">
             Exportar Excel
        </a>
    </div>
</div>

<div class="container-fluid">

    <div class="card shadow">

        <div class="card-header bg-dark text-white">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <input type="text"
                           id="buscarUbicacion"
                           class="form-control form-control-sm"
                           placeholder=" Buscar por Ubicaci贸n">
                </div>
            </div>
        </div>

        <div class="card-body">

            <table id="tablaInventario"
                   class="table table-striped table-bordered table-sm nowrap"
                   style="width:100%; table-layout: fixed;">

                <thead class="table-dark">
                    <tr>
                        <th>Ubicaci贸n</th>
                        <th>Cod EAN</th>
                        <th>Cod DUN</th>
                        <th>Sistema</th>
                        <th>Descripci贸n</th>
                        <th>Categor铆a</th>
                        <th>Conteo 01</th>
                        <th>Conteo 02</th>
                        <th>Diferencia</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for item in inventario %}
                    <tr>
                        <td class="fw-bold" title="{{ item.ubicacion }}">
                            {{ item.ubicacion }}
                        </td>
                        <td title="{{ item.cod_ean }}">{{ item.cod_ean }}</td>
                        <td title="{{ item.cod_dun }}">{{ item.cod_dun }}</td>
                        <td title="{{ item.cod_sistema }}">{{ item.cod_sistema }}</td>
                        <td title="{{ item.descripcion }}">{{ item.descripcion }}</td>
                        <td title="{{ item.categoria }}">{{ item.categoria }}</td>

                        <td>
                            <input type="number"
                                   class="form-control form-control-sm conteo text-end"
                                   data-id="{{ item.id }}"
                                   data-campo="conteo_01"
                                   value="{{ item.conteo_01|default_if_none:0 }}">
                        </td>

                        <td>
                            <input type="number"
                                   class="form-control form-control-sm conteo text-end"
                                   data-id="{{ item.id }}"
                                   data-campo="conteo_02"
                                   value="{{ item.conteo_02|default_if_none:0 }}">
                        </td>

                        <td class="text-end diferencia fw-bold">
                            {{ item.diferencia|default_if_none:0 }}
                        </td>

                        <td class="text-center">
                            <a href="{% url 'editar' item.id %}"
                               class="btn btn-warning btn-sm">
                                锔
                            </a>
                            <a href="{% url 'eliminar' item.id %}"
                               class="btn btn-danger btn-sm">
                                
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>

        </div>
    </div>
</div>

<!-- ================= CSS ================= -->
<link rel="stylesheet"
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">

<link rel="stylesheet"
      href="https://cdn.datatables.net/fixedcolumns/4.3.1/css/fixedColumns.bootstrap5.min.css">

<style>
/*  Control total de columnas y celdas */
#tablaInventario {
    table-layout: fixed;
}

/* Todo queda dentro de la celda */
#tablaInventario th,
#tablaInventario td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: middle;
}

/* Inputs contenidos */
#tablaInventario input {
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
}

/* Botones compactos */
#tablaInventario .btn {
    padding: 2px 6px;
    font-size: 0.75rem;
    white-space: nowrap;
}
</style>

<!-- ================= JS ================= -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.3.1/js/dataTables.fixedColumns.min.js"></script>

<script>
$(document).ready(function () {

    let tabla = $('#tablaInventario').DataTable({
        scrollY: '450px',
        scrollX: true,
        scrollCollapse: true,
        paging: true,

        autoWidth: false,

        fixedColumns: {
            left: 1
        },

        columnDefs: [
            { width: "140px", targets: 0 },
            { width: "120px", targets: 1 },
            { width: "120px", targets: 2 },
            { width: "120px", targets: 3 },
            { width: "220px", targets: 4 },
            { width: "140px", targets: 5 },
            { width: "110px", targets: 6 },
            { width: "110px", targets: 7 },
            { width: "110px", targets: 8 },
            { width: "120px", targets: 9 }
        ],

        pageLength: 25,
        lengthMenu: [10, 25, 50, 100],

        language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json"
        }
    });

    //  Buscar solo por Ubicaci贸n
    $('#buscarUbicacion').on('keyup change', function () {
        tabla.column(0).search(this.value).draw();
    });

    //  Guardar conteos sin deformar tabla
    $(document).on('change', '.conteo', function () {

        let input = $(this);
        let fila = input.closest('tr');

        $.ajax({
            url: "{% url 'actualizar_conteo' %}",
            method: "POST",
            data: {
                id: input.data('id'),
                campo: input.data('campo'),
                valor: input.val() || 0,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (data) {
                fila.find('.diferencia').text(data.diferencia);
            }
        });
    });

});
</script>

{% endblock %}
